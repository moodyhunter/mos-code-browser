<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"><title>idt.c source code [MOS/arch/x86/interrupt/idt.c] - Woboq Code Browser</title>
<link rel="stylesheet" href="/mos-code-browser/data/qtcreator.css" title="QtCreator"/>
<link rel="alternate stylesheet" href="/mos-code-browser/data/kdevelop.css" title="KDevelop"/>
<script type="text/javascript" src="/mos-code-browser/data/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/mos-code-browser/data/jquery/jquery-ui.min.js"></script>
<script>var file = 'MOS/arch/x86/interrupt/idt.c'; var root_path = '../../../..'; var data_path = '/mos-code-browser/data'; var ecma_script_api_version = 2;</script>
<script src='/mos-code-browser/data/codebrowser.js'></script>
</head>
<body><div id='header'><h1 id='breadcrumb'><span>Browse the source code of </span><a href='../../..'>MOS</a>/<a href='../..'>arch</a>/<a href='..'>x86</a>/<a href='./'>interrupt</a>/<a href='idt.c.html'>idt.c</a></h1></div>
<hr/><div id='content'><table class="code">
<tr><th id="1">1</th><td><i>// SPDX-License-Identifier: GPL-3.0-or-later</i></td></tr>
<tr><th id="2">2</th><td></td></tr>
<tr><th id="3">3</th><td><u>#include <a href="../../../kernel/include/mos/mos_global.h.html">"mos/mos_global.h"</a></u></td></tr>
<tr><th id="4">4</th><td><u>#include <a href="../../../kernel/include/mos/platform/platform.h.html">"mos/platform/platform.h"</a></u></td></tr>
<tr><th id="5">5</th><td><u>#include <a href="../include/mos/x86/devices/port.h.html">"mos/x86/devices/port.h"</a></u></td></tr>
<tr><th id="6">6</th><td><u>#include <a href="../include/mos/x86/interrupt/idt_types.h.html">"mos/x86/interrupt/idt_types.h"</a></u></td></tr>
<tr><th id="7">7</th><td><u>#include <a href="../include/mos/x86/interrupt/pic.h.html">"mos/x86/interrupt/pic.h"</a></u></td></tr>
<tr><th id="8">8</th><td><u>#include <a href="../include/mos/x86/x86_platform.h.html">"mos/x86/x86_platform.h"</a></u></td></tr>
<tr><th id="9">9</th><td></td></tr>
<tr><th id="10">10</th><td><u>#define <dfn class="macro" id="_M/PIC1_OFFSET" data-ref="_M/PIC1_OFFSET">PIC1_OFFSET</dfn> 0x20</u></td></tr>
<tr><th id="11">11</th><td><u>#define <dfn class="macro" id="_M/PIC2_OFFSET" data-ref="_M/PIC2_OFFSET">PIC2_OFFSET</dfn> 0x28</u></td></tr>
<tr><th id="12">12</th><td></td></tr>
<tr><th id="13">13</th><td><em>static</em> <a class="typedef" href="../include/mos/x86/interrupt/idt_types.h.html#idt_entry32_t" title='idt_entry32_t' data-type='struct idt_entry32_t' data-ref="idt_entry32_t" data-ref-filename="idt_entry32_t">idt_entry32_t</a> <dfn class="tu decl def" id="idt" title='idt' data-type='idt_entry32_t [256]' data-ref="idt" data-ref-filename="idt">idt</dfn>[<a class="macro" href="../include/mos/x86/x86_interrupt.h.html#13" title="256" data-ref="_M/IDT_ENTRY_COUNT">IDT_ENTRY_COUNT</a>] <a class="macro" href="../../../kernel/include/mos/mos_global.h.html#12" title="__attribute__((__aligned__(16)))" data-ref="_M/__aligned">__aligned</a>(<var>16</var>) = { <var>0</var> };</td></tr>
<tr><th id="14">14</th><td><em>static</em> <a class="typedef" href="../include/mos/x86/interrupt/idt_types.h.html#idtr32_t" title='idtr32_t' data-type='struct idtr32_t' data-ref="idtr32_t" data-ref-filename="idtr32_t">idtr32_t</a> <dfn class="tu decl def" id="idtr" title='idtr' data-type='idtr32_t' data-ref="idtr" data-ref-filename="idtr">idtr</dfn>;</td></tr>
<tr><th id="15">15</th><td></td></tr>
<tr><th id="16">16</th><td><u>#define <dfn class="macro" id="_M/IDT_FLAG_P" data-ref="_M/IDT_FLAG_P">IDT_FLAG_P</dfn> (1 &lt;&lt; 7)</u></td></tr>
<tr><th id="17">17</th><td></td></tr>
<tr><th id="18">18</th><td><u>#define <dfn class="macro" id="_M/STS_IG32" data-ref="_M/STS_IG32">STS_IG32</dfn> 0xE // 32-bit Interrupt Gate</u></td></tr>
<tr><th id="19">19</th><td><u>#define <dfn class="macro" id="_M/STS_TG32" data-ref="_M/STS_TG32">STS_TG32</dfn> 0xF // 32-bit Trap Gate</u></td></tr>
<tr><th id="20">20</th><td></td></tr>
<tr><th id="21">21</th><td><em>static</em> <em>void</em> <dfn class="tu decl def fn" id="idt_set_descriptor" title='idt_set_descriptor' data-type='void idt_set_descriptor(u8 vector, void * isr, _Bool usermode, _Bool is_trap)' data-ref="idt_set_descriptor" data-ref-filename="idt_set_descriptor">idt_set_descriptor</dfn>(<a class="typedef" href="../../../kernel/include/mos/types.h.html#u8" title='u8' data-type='unsigned char' data-ref="u8" data-ref-filename="u8">u8</a> <dfn class="local col3 decl" id="3vector" title='vector' data-type='u8' data-ref="3vector" data-ref-filename="3vector">vector</dfn>, <em>void</em> *<dfn class="local col4 decl" id="4isr" title='isr' data-type='void *' data-ref="4isr" data-ref-filename="4isr">isr</dfn>, <span class="macro" title="_Bool" data-ref="_M/bool">bool</span> <dfn class="local col5 decl" id="5usermode" title='usermode' data-type='_Bool' data-ref="5usermode" data-ref-filename="5usermode">usermode</dfn>, <span class="macro" title="_Bool" data-ref="_M/bool">bool</span> <dfn class="local col6 decl" id="6is_trap" title='is_trap' data-type='_Bool' data-ref="6is_trap" data-ref-filename="6is_trap">is_trap</dfn>)</td></tr>
<tr><th id="22">22</th><td>{</td></tr>
<tr><th id="23">23</th><td>    <a class="typedef" href="../include/mos/x86/interrupt/idt_types.h.html#idt_entry32_t" title='idt_entry32_t' data-type='struct idt_entry32_t' data-ref="idt_entry32_t" data-ref-filename="idt_entry32_t">idt_entry32_t</a> *<dfn class="local col7 decl" id="7descriptor" title='descriptor' data-type='idt_entry32_t *' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</dfn> = &amp;<a class="tu ref" href="#idt" title='idt' data-use='a' data-ref="idt" data-ref-filename="idt">idt</a>[<a class="local col3 ref" href="#3vector" title='vector' data-ref="3vector" data-ref-filename="3vector">vector</a>];</td></tr>
<tr><th id="24">24</th><td></td></tr>
<tr><th id="25">25</th><td>    <a class="local col7 ref" href="#7descriptor" title='descriptor' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</a>-&gt;<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::isr_low" title='(anonymous struct)::isr_low' data-ref="(anonymous)::isr_low" data-ref-filename="(anonymous)..isr_low">isr_low</a> = <span class='warning' title="cast to smaller integer type &apos;u32&apos; (aka &apos;unsigned int&apos;) from &apos;void *&apos;">(</span><a class="typedef" href="../../../kernel/include/mos/types.h.html#u32" title='u32' data-type='unsigned int' data-ref="u32" data-ref-filename="u32">u32</a>) <a class="local col4 ref" href="#4isr" title='isr' data-ref="4isr" data-ref-filename="4isr">isr</a> &amp; <var>0xFFFF</var>;</td></tr>
<tr><th id="26">26</th><td>    <a class="local col7 ref" href="#7descriptor" title='descriptor' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</a>-&gt;<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::isr_high" title='(anonymous struct)::isr_high' data-ref="(anonymous)::isr_high" data-ref-filename="(anonymous)..isr_high">isr_high</a> = <span class='warning' title="cast to smaller integer type &apos;u32&apos; (aka &apos;unsigned int&apos;) from &apos;void *&apos;">(</span><a class="typedef" href="../../../kernel/include/mos/types.h.html#u32" title='u32' data-type='unsigned int' data-ref="u32" data-ref-filename="u32">u32</a>) <a class="local col4 ref" href="#4isr" title='isr' data-ref="4isr" data-ref-filename="4isr">isr</a> &gt;&gt; <var>16</var>;</td></tr>
<tr><th id="27">27</th><td>    <a class="local col7 ref" href="#7descriptor" title='descriptor' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</a>-&gt;<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::segment" title='(anonymous struct)::segment' data-ref="(anonymous)::segment" data-ref-filename="(anonymous)..segment">segment</a> = <a class="macro" href="../include/mos/x86/x86_platform.h.html#14" title="0x08" data-ref="_M/GDT_SEGMENT_KCODE">GDT_SEGMENT_KCODE</a>;</td></tr>
<tr><th id="28">28</th><td>    <a class="local col7 ref" href="#7descriptor" title='descriptor' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</a>-&gt;<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::present" title='(anonymous struct)::present' data-ref="(anonymous)::present" data-ref-filename="(anonymous)..present">present</a> = <span class="macro" title="1" data-ref="_M/true">true</span>;</td></tr>
<tr><th id="29">29</th><td>    <a class="local col7 ref" href="#7descriptor" title='descriptor' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</a>-&gt;<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::dpl" title='(anonymous struct)::dpl' data-ref="(anonymous)::dpl" data-ref-filename="(anonymous)..dpl">dpl</a> = <a class="local col5 ref" href="#5usermode" title='usermode' data-ref="5usermode" data-ref-filename="5usermode">usermode</a> ? <var>3</var> : <var>0</var>;</td></tr>
<tr><th id="30">30</th><td>    <a class="local col7 ref" href="#7descriptor" title='descriptor' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</a>-&gt;<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::type" title='(anonymous struct)::type' data-ref="(anonymous)::type" data-ref-filename="(anonymous)..type">type</a> = <a class="local col6 ref" href="#6is_trap" title='is_trap' data-ref="6is_trap" data-ref-filename="6is_trap">is_trap</a> ? <a class="macro" href="#19" title="0xF" data-ref="_M/STS_TG32">STS_TG32</a> : <a class="macro" href="#18" title="0xE" data-ref="_M/STS_IG32">STS_IG32</a>;</td></tr>
<tr><th id="31">31</th><td>    <a class="local col7 ref" href="#7descriptor" title='descriptor' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</a>-&gt;<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::s" title='(anonymous struct)::s' data-ref="(anonymous)::s" data-ref-filename="(anonymous)..s">s</a> = <var>0</var>;</td></tr>
<tr><th id="32">32</th><td>    <a class="local col7 ref" href="#7descriptor" title='descriptor' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</a>-&gt;<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::reserved" title='(anonymous struct)::reserved' data-ref="(anonymous)::reserved" data-ref-filename="(anonymous)..reserved">reserved</a> = <var>0</var>;</td></tr>
<tr><th id="33">33</th><td>    <a class="local col7 ref" href="#7descriptor" title='descriptor' data-ref="7descriptor" data-ref-filename="7descriptor">descriptor</a>-&gt;<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::args" title='(anonymous struct)::args' data-ref="(anonymous)::args" data-ref-filename="(anonymous)..args">args</a> = <var>0</var>;</td></tr>
<tr><th id="34">34</th><td>}</td></tr>
<tr><th id="35">35</th><td></td></tr>
<tr><th id="36">36</th><td><em>void</em> <dfn class="decl def fn" id="x86_idt_init" title='x86_idt_init' data-ref="x86_idt_init" data-ref-filename="x86_idt_init">x86_idt_init</dfn>()</td></tr>
<tr><th id="37">37</th><td>{</td></tr>
<tr><th id="38">38</th><td>    <b>for</b> (<a class="typedef" href="../../../kernel/include/mos/types.h.html#u8" title='u8' data-type='unsigned char' data-ref="u8" data-ref-filename="u8">u8</a> <dfn class="local col8 decl" id="8isr" title='isr' data-type='u8' data-ref="8isr" data-ref-filename="8isr">isr</dfn> = <var>0</var>; <a class="local col8 ref" href="#8isr" title='isr' data-ref="8isr" data-ref-filename="8isr">isr</a> &lt; <a class="macro" href="../include/mos/x86/x86_interrupt.h.html#11" title="32" data-ref="_M/ISR_MAX_COUNT">ISR_MAX_COUNT</a>; <a class="local col8 ref" href="#8isr" title='isr' data-ref="8isr" data-ref-filename="8isr">isr</a>++)</td></tr>
<tr><th id="39">39</th><td>        <a class="tu ref fn" href="#idt_set_descriptor" title='idt_set_descriptor' data-use='c' data-ref="idt_set_descriptor" data-ref-filename="idt_set_descriptor">idt_set_descriptor</a>(<a class="local col8 ref" href="#8isr" title='isr' data-ref="8isr" data-ref-filename="8isr">isr</a>, <a class="ref" href="../include/mos/x86/x86_interrupt.h.html#isr_stub_table" title='isr_stub_table' data-ref="isr_stub_table" data-ref-filename="isr_stub_table">isr_stub_table</a>[<a class="local col8 ref" href="#8isr" title='isr' data-ref="8isr" data-ref-filename="8isr">isr</a>], <span class="macro" title="0" data-ref="_M/false">false</span>, <span class="macro" title="0" data-ref="_M/false">false</span>);</td></tr>
<tr><th id="40">40</th><td></td></tr>
<tr><th id="41">41</th><td>    <b>for</b> (<a class="typedef" href="../../../kernel/include/mos/types.h.html#u8" title='u8' data-type='unsigned char' data-ref="u8" data-ref-filename="u8">u8</a> <dfn class="local col9 decl" id="9irq_n" title='irq_n' data-type='u8' data-ref="9irq_n" data-ref-filename="9irq_n">irq_n</dfn> = <var>0</var>; <a class="local col9 ref" href="#9irq_n" title='irq_n' data-ref="9irq_n" data-ref-filename="9irq_n">irq_n</a> &lt; <a class="macro" href="../include/mos/x86/x86_interrupt.h.html#12" title="16" data-ref="_M/IRQ_MAX_COUNT">IRQ_MAX_COUNT</a>; <a class="local col9 ref" href="#9irq_n" title='irq_n' data-ref="9irq_n" data-ref-filename="9irq_n">irq_n</a>++)</td></tr>
<tr><th id="42">42</th><td>        <a class="tu ref fn" href="#idt_set_descriptor" title='idt_set_descriptor' data-use='c' data-ref="idt_set_descriptor" data-ref-filename="idt_set_descriptor">idt_set_descriptor</a>(<a class="local col9 ref" href="#9irq_n" title='irq_n' data-ref="9irq_n" data-ref-filename="9irq_n">irq_n</a> + <a class="macro" href="../include/mos/x86/x86_interrupt.h.html#9" title="0x20" data-ref="_M/IRQ_BASE">IRQ_BASE</a>, <a class="ref" href="../include/mos/x86/x86_interrupt.h.html#irq_stub_table" title='irq_stub_table' data-ref="irq_stub_table" data-ref-filename="irq_stub_table">irq_stub_table</a>[<a class="local col9 ref" href="#9irq_n" title='irq_n' data-ref="9irq_n" data-ref-filename="9irq_n">irq_n</a>], <span class="macro" title="0" data-ref="_M/false">false</span>, <span class="macro" title="0" data-ref="_M/false">false</span>);</td></tr>
<tr><th id="43">43</th><td></td></tr>
<tr><th id="44">44</th><td>    <i>// system calls</i></td></tr>
<tr><th id="45">45</th><td>    <a class="tu ref fn" href="#idt_set_descriptor" title='idt_set_descriptor' data-use='c' data-ref="idt_set_descriptor" data-ref-filename="idt_set_descriptor">idt_set_descriptor</a>(<a class="macro" href="../../../kernel/include/mos/constants.h.html#15" title="0x88" data-ref="_M/MOS_SYSCALL_INTR">MOS_SYSCALL_INTR</a>, <a class="ref" href="../include/mos/x86/x86_interrupt.h.html#isr_stub_table" title='isr_stub_table' data-ref="isr_stub_table" data-ref-filename="isr_stub_table">isr_stub_table</a>[<a class="macro" href="../../../kernel/include/mos/constants.h.html#15" title="0x88" data-ref="_M/MOS_SYSCALL_INTR">MOS_SYSCALL_INTR</a>], <span class="macro" title="1" data-ref="_M/true">true</span>, <span class="macro" title="1" data-ref="_M/true">true</span>);</td></tr>
<tr><th id="46">46</th><td></td></tr>
<tr><th id="47">47</th><td>    <a class="ref fn" href="../include/mos/x86/interrupt/pic.h.html#pic_remap_irq" title='pic_remap_irq' data-ref="pic_remap_irq" data-ref-filename="pic_remap_irq">pic_remap_irq</a>(<a class="macro" href="#10" title="0x20" data-ref="_M/PIC1_OFFSET">PIC1_OFFSET</a>, <a class="macro" href="#11" title="0x28" data-ref="_M/PIC2_OFFSET">PIC2_OFFSET</a>);</td></tr>
<tr><th id="48">48</th><td></td></tr>
<tr><th id="49">49</th><td>    <a class="tu ref" href="#idtr" title='idtr' data-use='m' data-ref="idtr" data-ref-filename="idtr">idtr</a>.<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::base" title='(anonymous struct)::base' data-ref="(anonymous)::base" data-ref-filename="(anonymous)..base">base</a> = &amp;<a class="tu ref" href="#idt" title='idt' data-use='a' data-ref="idt" data-ref-filename="idt">idt</a>[<var>0</var>];</td></tr>
<tr><th id="50">50</th><td>    <a class="tu ref" href="#idtr" title='idtr' data-use='m' data-ref="idtr" data-ref-filename="idtr">idtr</a>.<a class="ref field" href="../include/mos/x86/interrupt/idt_types.h.html#(anonymous)::limit" title='(anonymous struct)::limit' data-ref="(anonymous)::limit" data-ref-filename="(anonymous)..limit">limit</a> = (<a class="typedef" href="../../../kernel/include/mos/types.h.html#u16" title='u16' data-type='unsigned short' data-ref="u16" data-ref-filename="u16">u16</a>) <b>sizeof</b>(<a class="typedef" href="../include/mos/x86/interrupt/idt_types.h.html#idt_entry32_t" title='idt_entry32_t' data-type='struct idt_entry32_t' data-ref="idt_entry32_t" data-ref-filename="idt_entry32_t">idt_entry32_t</a>) * <a class="macro" href="../include/mos/x86/x86_interrupt.h.html#13" title="256" data-ref="_M/IDT_ENTRY_COUNT">IDT_ENTRY_COUNT</a> - <var>1</var>;</td></tr>
<tr><th id="51">51</th><td>    <a class="ref fn" href="../include/mos/x86/x86_platform.h.html#idt32_flush" title='idt32_flush' data-ref="idt32_flush" data-ref-filename="idt32_flush">idt32_flush</a>(&amp;<a class="tu ref" href="#idtr" title='idtr' data-use='a' data-ref="idtr" data-ref-filename="idtr">idtr</a>);</td></tr>
<tr><th id="52">52</th><td>}</td></tr>
<tr><th id="53">53</th><td></td></tr>
</table><hr/><p id='footer'>
Generated on <em>2022-Dec-12</em> from project MOS<br />Powered by <a href='https://woboq.com'><img alt='Woboq' src='https://code.woboq.org/woboq-16.png' width='41' height='16' /></a> <a href='https://code.woboq.org'>Code Browser</a> 2.1
<br/>Generator usage only permitted with license.</p>
</div></body></html>
